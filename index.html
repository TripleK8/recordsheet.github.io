<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>20m-SRT - Office Ready</title>
    
    <!-- PDF Library (Online) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> 
    <script>
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÑ‡∏´‡∏° ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà (Offline) ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î Print ‡πÅ‡∏ó‡∏ô
        window.isPdfLibLoaded = typeof window.jspdf !== 'undefined';
    </script>

    <style>
        :root {
            --bg-color: #f4f6f8;
            --container-bg: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --accent-color: #3498db; 
            --highlight-color: #e67e22; 
            --timer-color: #27ae60; 
            --countdown-color: #e74c3c; 
            --pause-color: #f39c12; 
            --speed-color: #9b59b6; 
            --pilot-color: #16a085;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --font-main: 'Sarabun', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            text-align: center;
            background-color: var(--container-bg);
            padding: 40px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 800px;
            position: relative;
        }

        /* Audio Status Indicator */
        .audio-status-bar {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #6c757d;
            padding: 8px;
            border-radius: 8px;
            font-size: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        .audio-status-bar.ready {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .audio-status-bar.error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        h1 {
            margin-bottom: 30px;
            margin-top: 10px;
            font-size: 28px;
            color: var(--accent-color);
            font-weight: 700;
        }
        
        .display-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        @media (min-width: 600px) {
            .display-grid { grid-template-columns: repeat(3, 1fr); }
        }

        .stat-box {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-sub);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-main);
        }

        #cum-stat-box {
            grid-column: 1 / -1;
            background-color: var(--highlight-color);
            color: white;
            padding: 25px;
            border: 3px solid #f9fafb; 
        }
        #cum-stat-box .stat-label { color: white; }
        #cum-display { color: white !important; font-size: 56px; }

        #dist-display { color: var(--accent-color); } 
        #speed-display { color: var(--speed-color); }

        .timer-display {
            font-size: 20px;
            color: var(--text-sub);
            margin-top: 15px;
            font-variant-numeric: tabular-nums;
            font-weight: 500;
        }
        
        #total-time {
            color: var(--timer-color);
            font-weight: 700;
            font-size: 24px;
        }
        
        .score-display {
            background-color: #edf7ed;
            color: #1e4620;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 18px;
            font-weight: 600;
            border: 1px solid #c8e6c9;
            line-height: 1.5;
        }
        
        #score-text {
            color: #2e7d32;
            font-weight: 700;
            font-size: 20px;
            display: block;
            margin-top: 5px;
        }
        
        .score-buttons-container {
            margin-top: 30px;
            padding: 15px;
            border-top: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            background-color: #fcfcfc;
            border-radius: 10px;
        }

        .score-label-btn {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 10px;
        }

        .runner-buttons-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        @media (min-width: 600px) {
            .runner-buttons-grid { grid-template-columns: repeat(10, 1fr); }
        }
        
        .runner-score-btn {
            background-color: #34495e;
            color: white;
            border: none;
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            line-height: 1;
        }
        .runner-score-btn.recorded {
            background-color: var(--timer-color);
            font-weight: bold;
        }

        .saved-results-container {
            margin-top: 30px;
            text-align: left;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 12px;
        }

        .results-title {
            font-size: 20px;
            color: var(--highlight-color);
            margin-bottom: 10px;
            border-bottom: 2px solid var(--highlight-color);
            padding-bottom: 5px;
            font-weight: 700;
        }

        .results-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .results-list li {
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
            font-size: 16px;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
        }
        .runner-id {
            font-weight: bold;
            color: var(--accent-color);
        }
        .runner-score-detail {
            color: #555;
            font-size: 14px;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
            width: 100%;
        }
        
        button.action-btn {
            background-color: var(--accent-color);
            color: #fff;
            border: none;
            padding: 18px 40px;
            font-size: 20px;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            min-width: 180px;
            transition: transform 0.2s;
        }
        button.action-btn:hover { transform: translateY(-2px); }

        button.end-set-btn {
            background-color: #8e44ad;
            box-shadow: 0 4px 15px rgba(142, 68, 173, 0.3);
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background-color: #e9ecef;
            border-radius: 6px;
            margin-top: 25px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--accent-color);
            width: 0%;
            transition: width 0.1s linear;
        }

        .status-text {
            margin-top: 20px;
            font-size: 22px;
            font-weight: 600;
            height: 30px;
        }

        .next-beep-box {
            background-color: #fff3cd; 
            border: 1px solid #ffeeba;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        #countdown-display {
            color: var(--countdown-color);
            font-size: 36px;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            text-align: left;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 10px;
        }

        .modal-confirm-btn { background-color: #e74c3c; color: white; }
        .modal-cancel-btn { background-color: #ecf0f1; color: var(--text-main); }

        /* --- PRINT STYLES FOR OFFLINE OFFICE USE --- */
        @media print {
            body { 
                background-color: white; 
                color: black; 
                padding: 0;
            }
            .container { 
                box-shadow: none; 
                border: none; 
                width: 100%; 
                max-width: 100%; 
                padding: 0; 
                margin: 0;
            }
            /* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡∏ó‡πå */
            .audio-status-bar, 
            .display-grid, 
            .next-beep-box, 
            .score-buttons-container, 
            .progress-bar, 
            .button-group, 
            #status-text, 
            .modal-overlay,
            .timer-display,
            .score-display,
            .control-row {
                display: none !important;
            }
            
            /* ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå */
            h1 { font-size: 24px; margin-bottom: 10px; color: black; border-bottom: 2px solid #000; padding-bottom: 10px; }
            .saved-results-container { margin-top: 0; background-color: white; padding: 0; }
            .results-title { color: black; font-size: 18px; border-bottom: 1px solid #000; margin-top: 20px; }
            .results-list li { border-bottom: 1px solid #ccc; page-break-inside: avoid; }
            .runner-id { color: #000; }
            .runner-score-detail { color: #333; }
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Audio Status Indicator -->
        <div id="audio-status" class="audio-status-bar">
            <span>üîå Waiting for Audio...</span>
        </div>

        <h1>20m-SRT (Shuttle Run Test)</h1>
        
        <div class="display-grid">
            <div class="stat-box" id="cum-stat-box">
                <div class="stat-label">Cumulative Laps (‡∏£‡∏ß‡∏°‡∏£‡∏≠‡∏ö)</div>
                <div class="stat-value" id="cum-display">0</div> 
            </div>
            <div class="stat-box">
                <div class="stat-label">Level</div>
                <div class="stat-value" id="level-display">1</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Laps</div>
                <div class="stat-value" id="shuttle-display">1</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Speed</div>
                <div class="stat-value" id="speed-display">8.5</div>
                <div class="stat-label" style="font-size: 10px; margin-top: -5px;">km/h</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Distance (m)</div>
                <div class="stat-value" id="dist-display">0</div>
            </div>
        </div>

        <div class="next-beep-box">
             <div class="stat-label" style="color: #856404;">Next Beep In (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</div>
             <div class="stat-value" id="countdown-display">0.00</div>
        </div>

        <div class="timer-display">Total Time: <span id="total-time">00:00</span></div>
        
        <div class="score-display">
            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏• (Score): <span id="score-text">Level 1 - Lap 0 | ‡∏£‡∏ß‡∏° 0 ‡∏£‡∏≠‡∏ö | 0 ‡∏°. | MRS: 0.0 km/h</span>
        </div>
        
        <div class="status-text" id="status-text">Ready to Start</div>
        
        <div class="score-buttons-container">
            <div class="score-label-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</div>
            <div id="runner-buttons" class="runner-buttons-grid"></div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        
        <div class="button-group">
            <button id="start-btn" class="action-btn" onclick="startTest()">START TEST</button>
            <button id="pause-btn" class="action-btn" onclick="togglePause()" style="display: none; background-color: var(--pause-color);">PAUSE</button>
            <button id="next-set-btn" class="action-btn end-set-btn" onclick="finishTestAndAdvance()" style="display: none;">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏õ (Manual)</button>
            <button id="reset-btn" class="action-btn" onclick="resetTest()" style="display: none; background-color: #e74c3c;">RESET ALL</button>
            <button id="pdf-export-btn" class="action-btn" onclick="handleExport()" style="display: none;">‚¨áÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF / Print</button>
        </div>
        
        <div class="saved-results-container">
            <h2 class="results-title">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</h2>
            <ul id="saved-results-list" class="results-list">
                <li>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</li>
            </ul>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="custom-modal">
        <div class="modal-content">
            <div id="modal-title" style="font-weight: bold; margin-bottom: 10px; font-size: 20px;">‚ÑπÔ∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
            <div id="modal-body" style="margin-bottom: 20px; line-height: 1.5;"></div>
            <input type="password" id="modal-input" style="display:none; width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px;" placeholder="Admin Password (1234)">
            <div id="modal-actions" style="display:flex; justify-content: flex-end;"></div>
        </div>
    </div>

    <script>
        // === Audio & Bluetooth Handling (FIXED) ===
        let audioCtx = null;
        const statusDiv = document.getElementById('audio-status');

        function updateAudioStatus(msg, type) {
            statusDiv.innerHTML = msg;
            statusDiv.className = 'audio-status-bar ' + type;
        }

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                audioCtx.onstatechange = () => {
                    if (audioCtx.state === 'running') {
                        updateAudioStatus("üì° Audio Active (Bluetooth Ready)", "ready");
                    } else if (audioCtx.state === 'suspended' || audioCtx.state === 'interrupted') {
                        updateAudioStatus("‚ö†Ô∏è Audio Suspended - Click to Resume", "error");
                    }
                };
            }
            
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            
            updateAudioStatus("üì° Audio Active (Bluetooth Ready)", "ready");
        }

        if (navigator.mediaDevices && navigator.mediaDevices.addEventListener) {
            navigator.mediaDevices.addEventListener('devicechange', async () => {
                console.log("Device change detected. Re-syncing...");
                updateAudioStatus("üîÑ Re-syncing Audio Device...", "error");
                
                if (audioCtx) {
                    try {
                        if (audioCtx.state !== 'running') {
                            await audioCtx.resume();
                        }
                        if (isRunning) playTone(0.1, 500); 
                    } catch (e) {
                        console.error("Audio resume failed:", e);
                    }
                }
            });
        }

        // 500Hz Beep (Middle frequency)
        function playTone(duration = 0.7, freq = 500) {
            if (!audioCtx) initAudio();
            if (audioCtx.state === 'suspended' || audioCtx.state === 'interrupted') {
                audioCtx.resume();
            }

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.type = 'sine'; 
            osc.frequency.value = freq;
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô 1.0 (‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏° 0.5) = 200%
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(1.0, audioCtx.currentTime + 0.05); 
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + duration - 0.1);

            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        // === TTS ===
        let thaiVoice = null;
        if ('speechSynthesis' in window) {
            speechSynthesis.onvoiceschanged = () => {
                 const voices = speechSynthesis.getVoices();
                 thaiVoice = voices.find(v => v.lang === 'th-TH') || null;
            };
        }

        function speak(text) {
             if (!('speechSynthesis' in window)) return;
             speechSynthesis.cancel(); 
             const u = new SpeechSynthesisUtterance(text);
             u.lang = 'th-TH';
             u.rate = 1.0;
             u.pitch = 1.2;
             if (thaiVoice) u.voice = thaiVoice;
             speechSynthesis.speak(u);
        }

        // === State Management ===
        let testSets = { total: 1, current: 1, data: {} };
        let currentLevelIndex = 0;
        let currentShuttleCount = 0;
        let totalCumulativeLaps = 0;
        let isRunning = false;
        let isPaused = false;
        let startTime = 0;
        let timerInterval;
        let shuttleStartTime = 0;
        let shuttleDuration = 0;
        let pauseStartTimestamp = 0;
        const ADMIN_PASSWORD = "1234";

        const pacerData = [
            { level: 1,  shuttles: 7,  seconds: 8.47, speed: 8.5, cumulative: 7 },
            { level: 2,  shuttles: 8,  seconds: 8.00, speed: 9.0, cumulative: 15 },
            { level: 3,  shuttles: 8,  seconds: 7.58, speed: 9.5, cumulative: 23 },
            { level: 4,  shuttles: 8,  seconds: 7.20, speed: 10.0, cumulative: 31 },
            { level: 5,  shuttles: 9,  seconds: 6.86, speed: 10.5, cumulative: 40 },
            { level: 6,  shuttles: 9,  seconds: 6.55, speed: 11.0, cumulative: 49 },
            { level: 7,  shuttles: 10, seconds: 6.26, speed: 11.5, cumulative: 59 },
            { level: 8,  shuttles: 10, seconds: 6.00, speed: 12.0, cumulative: 69 },
            { level: 9,  shuttles: 10, seconds: 5.76, speed: 12.5, cumulative: 79 },
            { level: 10, shuttles: 11, seconds: 5.54, speed: 13.0, cumulative: 90 },
            { level: 11, shuttles: 11, seconds: 5.33, speed: 13.5, cumulative: 101 },
            { level: 12, shuttles: 12, seconds: 5.14, speed: 14.0, cumulative: 113 },
            { level: 13, shuttles: 12, seconds: 4.97, speed: 14.5, cumulative: 125 },
            { level: 14, shuttles: 13, seconds: 4.80, speed: 15.0, cumulative: 138 },
            { level: 15, shuttles: 13, seconds: 4.65, speed: 15.5, cumulative: 151 },
            { level: 16, shuttles: 13, seconds: 4.50, speed: 16.0, cumulative: 164 },
            { level: 17, shuttles: 14, seconds: 4.36, speed: 16.5, cumulative: 178 },
            { level: 18, shuttles: 14, seconds: 4.24, speed: 17.0, cumulative: 192 },
            { level: 19, shuttles: 15, seconds: 4.11, speed: 17.5, cumulative: 207 },
            { level: 20, shuttles: 15, seconds: 4.00, speed: 18.0, cumulative: 222 },
            { level: 21, shuttles: 15, seconds: 3.89, speed: 18.5, cumulative: 237 }
        ];

        function closeModal() {
            document.getElementById('custom-modal').style.display = 'none';
            document.getElementById('modal-input').style.display = 'none';
            document.getElementById('modal-input').value = '';
        }

        function showModal(title, message, isError = false) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-title').style.color = isError ? '#e74c3c' : '#e67e22';
            document.getElementById('modal-body').innerText = message;
            document.getElementById('modal-input').style.display = 'none';
            document.getElementById('modal-actions').innerHTML = `<button class="modal-btn modal-cancel-btn" onclick="closeModal()">OK</button>`;
            document.getElementById('custom-modal').style.display = 'flex';
        }

        function showPasswordModal(onConfirmCallback) {
            document.getElementById('modal-title').innerHTML = 'üîí ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•';
            document.getElementById('modal-title').style.color = '#e74c3c';
            document.getElementById('modal-body').innerText = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (1234):';
            
            const inputField = document.getElementById('modal-input');
            inputField.style.display = 'block';
            inputField.value = '';
            
            document.getElementById('modal-actions').innerHTML = `
                <button class="modal-btn modal-cancel-btn" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="modal-btn modal-confirm-btn" id="modal-confirm-action">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            `;
            
            document.getElementById('custom-modal').style.display = 'flex';
            inputField.focus();

            document.getElementById('modal-confirm-action').onclick = () => {
                if (inputField.value === ADMIN_PASSWORD) {
                    closeModal();
                    onConfirmCallback();
                } else {
                    alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                }
            };
        }

        function startTest() {
            if (isRunning) return;
            initAudio();
            
            let countdown = 6;
            document.getElementById('status-text').innerText = `Starting...`;
            document.getElementById('start-btn').style.display = 'none';
            
            const preInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    document.getElementById('status-text').innerText = `Starting in ${countdown}...`;
                    if (countdown <= 5) {
                        const thaiNum = ["", "‡∏´‡∏ô‡∏∂‡πà‡∏á", "‡∏™‡∏≠‡∏á", "‡∏™‡∏≤‡∏°", "‡∏™‡∏µ‡πà", "‡∏´‡πâ‡∏≤"];
                        speak(thaiNum[countdown]);
                    }
                } else {
                    clearInterval(preInterval);
                    document.getElementById('status-text').innerText = "RUN!";
                    playTone(1.0, 500); 
                    beginPacerLogic();
                }
            }, 1000);
        }

        function beginPacerLogic() {
            isRunning = true;
            isPaused = false;
            startTime = Date.now();
            currentLevelIndex = 0;
            currentShuttleCount = 0;
            totalCumulativeLaps = 0;
            toggleButtonsState();
            startShuttle();
            startInterval();
        }

        function startShuttle() {
            const data = pacerData[currentLevelIndex];
            shuttleDuration = data.seconds;
            shuttleStartTime = Date.now();
            updateDisplay();
        }

        function startInterval() {
            timerInterval = setInterval(() => {
                if (isPaused) return;
                const now = Date.now();
                const elapsed = (now - shuttleStartTime) / 1000;
                let remaining = Math.max(0, shuttleDuration - elapsed);

                document.getElementById('total-time').innerText = formatTime(now - startTime);
                document.getElementById('countdown-display').innerText = remaining.toFixed(2);
                document.getElementById('progress-fill').style.width = `${(elapsed / shuttleDuration) * 100}%`;

                if (remaining <= 0.05) { 
                    nextShuttle();
                }
            }, 20); 
        }

        function nextShuttle() {
            totalCumulativeLaps++;
            const data = pacerData[currentLevelIndex];
            currentShuttleCount++;

            if (currentShuttleCount > data.shuttles) {
                currentLevelIndex++;
                currentShuttleCount = 1; 
                if (currentLevelIndex >= pacerData.length) {
                    finishTest();
                    return;
                }
            }
            
            playTone();
            startShuttle();
        }

        function updateDisplay() {
            const data = pacerData[currentLevelIndex];
            document.getElementById('level-display').innerText = data.level;
            document.getElementById('shuttle-display').innerText = currentShuttleCount; 
            document.getElementById('speed-display').innerText = data.speed.toFixed(1);
            document.getElementById('cum-display').innerText = totalCumulativeLaps;
            document.getElementById('dist-display').innerText = (totalCumulativeLaps * 20).toLocaleString();
            
            const mrs = getMaxSpeed(totalCumulativeLaps);
            const scoreStr = getFormattedScore(totalCumulativeLaps);
            document.getElementById('score-text').innerText = `${scoreStr} | MRS: ${mrs.toFixed(1)} km/h | ‡∏£‡∏ß‡∏° ${totalCumulativeLaps} ‡∏£‡∏≠‡∏ö`;
        }

        function formatTime(ms) {
            const s = Math.floor(ms / 1000);
            return `${Math.floor(s / 60).toString().padStart(2, '0')}:${(s % 60).toString().padStart(2, '0')}`;
        }

        function togglePause() {
            isPaused = !isPaused;
            if (isPaused) {
                pauseStartTimestamp = Date.now();
                document.getElementById('status-text').innerText = "PAUSED";
                document.getElementById('pause-btn').innerText = "RESUME";
                document.getElementById('pause-btn').style.backgroundColor = '#27ae60';
            } else {
                const diff = Date.now() - pauseStartTimestamp;
                startTime += diff;
                shuttleStartTime += diff;
                document.getElementById('status-text').innerText = "Running...";
                document.getElementById('pause-btn').innerText = "PAUSE";
                document.getElementById('pause-btn').style.backgroundColor = 'var(--pause-color)';
            }
        }

        function finishTest(isManual = false) {
            clearInterval(timerInterval);
            isRunning = false;
            playTone(0.5, 500); playTone(0.5, 500);
            document.getElementById('status-text').innerText = "Test Completed!";
            document.getElementById('start-btn').innerText = "START NEW TEST";
            toggleButtonsState();
            
            if (isManual) {
                showModal('‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', `‡∏à‡∏ö‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${testSets.current} ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡πÑ‡∏õ`, false);
                changeSet(1);
                performReset(true);
            }
        }

        function saveRunnerScore(id) {
            if (totalCumulativeLaps === 0 && !isRunning) {
                 showModal('‚ö†Ô∏è ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÑ‡∏î‡πâ', true);
                 return;
            }
            const key = `${testSets.current}-${id}`;
            if (testSets.data[key]) {
                delete testSets.data[key];
            } else {
                testSets.data[key] = {
                    runnerId: id,
                    set: testSets.current,
                    score: totalCumulativeLaps,
                    levelLap: getFormattedScore(totalCumulativeLaps),
                    distance: totalCumulativeLaps * 20,
                    time: document.getElementById('total-time').innerText,
                    maxSpeed: getMaxSpeed(totalCumulativeLaps).toFixed(1),
                    timestamp: Date.now() 
                };
            }
            renderRunnerScores();
        }

        function getMaxSpeed(laps) {
            if (laps <= 0) return 0.0;
            let speed = pacerData[0].speed;
            for(let d of pacerData) {
                if(laps >= d.cumulative) speed = d.speed;
                else break;
            }
            return speed;
        }

        function getFormattedScore(laps) {
            if (laps <= 0) return "Level 1 - Lap 0";
            for(let i=pacerData.length-1; i>=0; i--) {
                const prevCum = i>0 ? pacerData[i-1].cumulative : 0;
                if(laps > prevCum) {
                    return `Level ${pacerData[i].level} - Lap ${laps - prevCum}`;
                }
            }
            return "Level 1 - Lap 1";
        }

        function renderRunnerScores() {
            const list = document.getElementById('saved-results-list');
            list.innerHTML = '';
            
            let items = Object.values(testSets.data).sort((a,b) => {
                if(a.set !== b.set) return a.set - b.set;
                return a.timestamp - b.timestamp;
            });

            if (items.length === 0) {
                list.innerHTML = '<li>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</li>';
            } else {
                let lastSet = 0;
                items.forEach(s => {
                    if (s.set !== lastSet) {
                         const h = document.createElement('li');
                         h.className = 'results-title';
                         h.innerText = `‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà ${s.set}`;
                         h.style.borderBottom = "1px solid #ddd";
                         list.appendChild(h);
                         lastSet = s.set;
                    }
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="runner-id">#${s.runnerId}</span> <span class="runner-score-detail">${s.levelLap} | ${s.score} ‡∏£‡∏≠‡∏ö (${s.distance} ‡∏°.) | MRS: ${s.maxSpeed}</span>`;
                    list.appendChild(li);
                });
            }
            setupRunnerButtons();
        }

        function setupRunnerButtons() {
            const grid = document.getElementById('runner-buttons');
            grid.innerHTML = '';
            for (let i = 1; i <= 10; i++) {
                const btn = document.createElement('button');
                btn.className = 'runner-score-btn runner-id-' + i;
                const key = `${testSets.current}-${i}`;
                if (testSets.data[key]) {
                    btn.classList.add('recorded');
                    btn.innerText = `#${i} (${testSets.data[key].score})`;
                } else {
                    btn.innerText = `#${i}`;
                }
                btn.onclick = () => saveRunnerScore(i);
                grid.appendChild(btn);
            }
        }

        function toggleButtonsState() {
            const hasData = Object.keys(testSets.data).length > 0;
            document.getElementById('start-btn').style.display = isRunning || isPaused ? 'none' : 'inline-block';
            document.getElementById('pause-btn').style.display = isRunning || isPaused ? 'inline-block' : 'none';
            document.getElementById('reset-btn').style.display = (isRunning || isPaused || hasData) ? 'inline-block' : 'none';
            document.getElementById('pdf-export-btn').style.display = hasData ? 'inline-block' : 'none';
            document.getElementById('next-set-btn').style.display = (isRunning || isPaused) ? 'inline-block' : 'none';
        }

        function performReset(keepScores) {
            clearInterval(timerInterval);
            isRunning = false;
            isPaused = false;
            startTime = 0;
            currentLevelIndex = 0;
            currentShuttleCount = 0;
            totalCumulativeLaps = 0;
            if(!keepScores) {
                testSets.data = {};
                testSets.current = 1;
            }
            renderRunnerScores();
            updateDisplay(); 
            document.getElementById('status-text').innerText = "Ready to Start";
            toggleButtonsState();
        }

        function resetTest() {
            showPasswordModal(() => {
                performReset(false);
                showModal('‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', false);
            });
        }
        
        function finishTestAndAdvance() {
            finishTest(true);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Export ‡∏ó‡∏µ‡πà‡∏â‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å PDF (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏ô‡πá‡∏ï) ‡∏´‡∏£‡∏∑‡∏≠ Print (‡∏ñ‡πâ‡∏≤ Offline)
        function handleExport() {
            if (typeof window.jspdf === 'undefined') {
                // Offline Mode: ‡πÉ‡∏ä‡πâ window.print()
                window.print();
            } else {
                // Online Mode: ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏™‡∏ß‡∏¢‡πÜ
                exportToPDF();
            }
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const exportAll = true; // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ä‡∏∏‡∏î‡πÄ‡∏™‡∏°‡∏≠
            
            const dateObj = new Date();
            const today = `${String(dateObj.getDate()).padStart(2,'0')}-${String(dateObj.getMonth()+1).padStart(2,'0')}-${dateObj.getFullYear()}`;
            
            doc.setFont("Helvetica", "bold");
            doc.text("20m-SRT Test Results", 14, 20);
            doc.setFont("Helvetica", "normal");
            doc.setFontSize(10);
            doc.text(`Date: ${today}`, 14, 26); 
            
            let y = 35;
            let items = Object.values(testSets.data).filter(d => exportAll || d.set === testSets.current);
            
             items.sort((a,b) => {
                if(a.set !== b.set) return a.set - b.set;
                return a.timestamp - b.timestamp; 
            });

            if(items.length === 0) {
                showModal('‚ö†Ô∏è', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export', true);
                return;
            }

            let lastSet = 0;
            items.forEach(s => {
                if (y > 280) { doc.addPage(); y = 20; }
                if (s.set !== lastSet) {
                    y += 5;
                    doc.setFont("Helvetica", "bold");
                    doc.text(`Set ${s.set}`, 14, y);
                    doc.setFont("Helvetica", "normal");
                    y += 7;
                    lastSet = s.set;
                }
                doc.text(`Runner #${s.runnerId}: ${s.score} laps (${s.distance}m) - MRS: ${s.maxSpeed} km/h - Time: ${s.time}`, 14, y);
                y += 7;
            });

            doc.save(`PACER_AllSets_${today}.pdf`);
        }

        function changeSet(val) {
            let next = testSets.current + val;
            if (next >= 1 && next <= testSets.total) {
                testSets.current = next;
                renderRunnerScores();
            }
        }

        function updateTotalSets(v) { testSets.total = parseInt(v); }

        window.addEventListener('beforeunload', (e) => {
            if (isRunning) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        window.onload = () => {
            setupRunnerButtons();
            updateAudioStatus("üí§ Waiting for user interaction...", "ready");
        };
    </script>
</body>
</html>
